<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>CCレモン リズムバトル</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
	<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
	<style>
		body {
			font-family: 'Press Start 2P', cursive;
			touch-action: manipulation;
			/* ダブルタップズームを無効化 */
		}

		.action-button {
			transition: all 0.1s ease;
		}

		.action-button:active {
			transform: scale(0.95);
		}

		.action-button:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		.beat-indicator.active {
			transform: scale(1.2);
			background-color: #fef08a;
			/* yellow-200 */
			color: #1f2937;
			/* gray-800 */
		}

		.player-action-display,
		.cpu-action-display {
			transition: transform 0.2s ease-out, opacity 0.2s ease-out, color 0.2s ease-out;
		}

		.player-panel,
		.cpu-panel {
			transition: border-color 0.2s ease-in-out, background-color 0.2s ease-in-out;
		}

		.action-enter {
			transform: scale(1.5);
			opacity: 1;
		}

		.status-update {
			animation: flash 0.5s ease-out;
		}

		@keyframes flash {

			0%,
			100% {
				opacity: 1;
			}

			50% {
				opacity: 0.5;
			}
		}
	</style>
</head>

<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">
	<div id="game-container" class="w-full max-w-4xl mx-auto p-4 md:p-6">
		<div class="text-center mb-4">
			<h1 class="text-4xl md:text-5xl font-bold text-yellow-300">CC LEMON</h1>
			<p class="text-gray-400">Rhythm Battle</p>
		</div>

		<!-- ゲーム画面 -->
		<div id="game-screen" class="space-y-4 hidden">
			<!-- 拍子インジケーター -->
			<div class="flex justify-center space-x-2 md:space-x-4 my-4">
				<div id="beat-1"
					class="beat-indicator w-12 h-12 md:w-16 md:h-16 rounded-full border-2 border-gray-600 flex items-center justify-center text-xl md:text-2xl transition-transform">
					1</div>
				<div id="beat-2"
					class="beat-indicator w-12 h-12 md:w-16 md:h-16 rounded-full border-2 border-gray-600 flex items-center justify-center text-xl md:text-2xl transition-transform">
					2</div>
				<div id="beat-3"
					class="beat-indicator w-12 h-12 md:w-16 md:h-16 rounded-full border-2 border-yellow-400 flex items-center justify-center text-xl md:text-2xl transition-transform">
					3</div>
				<div id="beat-4"
					class="beat-indicator w-12 h-12 md:w-16 md:h-16 rounded-full border-2 border-gray-600 flex items-center justify-center text-xl md:text-2xl transition-transform">
					4</div>
			</div>

			<!-- メッセージエリア -->
			<div class="h-12 text-center flex items-center justify-center">
				<p id="message-text" class="text-lg md:text-xl text-yellow-300">&nbsp;</p>
			</div>

			<!-- プレイヤー vs CPU -->
			<div class="grid grid-cols-2 gap-4 md:gap-8 items-center">
				<!-- プレイヤーエリア -->
				<div id="player-panel" class="player-panel bg-gray-800/50 p-4 rounded-lg border-2 border-gray-300">
					<h2 class="text-2xl text-center mb-4">PLAYER</h2>
					<div class="text-lg">HP: <span id="player-hp" class="font-bold text-green-400">3</span></div>
					<div class="text-lg">CHARGE: <span id="player-charge" class="font-bold text-yellow-400">0</span>
					</div>
					<div class="h-20 flex items-center justify-center mt-4">
						<span id="player-action-display"
							class="player-action-display text-4xl font-bold opacity-0"></span>
					</div>
				</div>

				<!-- CPUエリア -->
				<div id="cpu-panel" class="cpu-panel bg-gray-800/50 p-4 rounded-lg border-2 border-gray-300">
					<h2 class="text-2xl text-center mb-4">CPU</h2>
					<div class="text-lg">HP: <span id="cpu-hp" class="font-bold text-green-400">3</span></div>
					<div class="text-lg">CHARGE: <span id="cpu-charge" class="font-bold text-yellow-400">0</span></div>
					<div class="h-20 flex items-center justify-center mt-4">
						<span id="cpu-action-display" class="cpu-action-display text-4xl font-bold opacity-0"></span>
					</div>
				</div>
			</div>

			<!-- アクションボタン -->
			<div class="grid grid-cols-3 gap-2 md:gap-4 pt-4">
				<button id="charge-button" data-action="CHARGE"
					class="action-button bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-4 md:py-6 rounded-lg text-lg md:text-2xl">CHARGE</button>
				<button id="guard-button" data-action="GUARD"
					class="action-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 md:py-6 rounded-lg text-lg md:text-2xl">GUARD</button>
				<button id="attack-button" data-action="ATTACK"
					class="action-button bg-red-500 hover:bg-red-600 text-white font-bold py-4 md:py-6 rounded-lg text-lg md:text-2xl">ATTACK</button>
			</div>
		</div>

		<!-- スタート画面 -->
		<div id="start-screen" class="text-center">
			<h2 class="text-2xl mb-4">HOW TO PLAY</h2>
			<p class="mb-2">1,2拍目でリズムを取り、3拍目で行動を選択！</p>
			<div class="text-left max-w-md mx-auto space-y-2 mb-6 bg-gray-800 p-4 rounded-lg">
				<p><span class="text-yellow-400 font-bold">CHARGE (Shift):</span> 攻撃用のエネルギーを1つ溜める。</p>
				<p><span class="text-blue-400 font-bold">GUARD (Space):</span> 相手のATTACKを完全に防ぐ。</p>
				<p class="text-gray-400 text-sm pl-4">- 連続では使用できない。</p>
				<p><span class="text-red-400 font-bold">ATTACK (Enter):</span> CHARGEを1つ消費して攻撃。CHARGE中の相手に有効。</p>
			</div>
			<p class="mb-8 text-gray-400">※音声が出ます。最初に画面をクリックしてください。</p>
			<button id="start-button"
				class="bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-8 rounded-lg text-2xl animate-pulse">START
				GAME</button>
		</div>

		<!-- ゲームオーバー画面 -->
		<div id="game-over-screen" class="text-center hidden">
			<h2 id="game-over-message" class="text-5xl mb-8"></h2>
			<button id="restart-button"
				class="bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-8 rounded-lg text-2xl">RESTART</button>
		</div>
	</div>

	<script>
		// --- DOM要素の取得 ---
		const gameScreen = document.getElementById('game-screen');
		const startScreen = document.getElementById('start-screen');
		const gameOverScreen = document.getElementById('game-over-screen');
		const startButton = document.getElementById('start-button');
		const restartButton = document.getElementById('restart-button');
		const messageText = document.getElementById('message-text');
		const playerHpEl = document.getElementById('player-hp');
		const playerChargeEl = document.getElementById('player-charge');
		const playerActionDisplay = document.getElementById('player-action-display');
		const playerPanel = document.getElementById('player-panel');
		const cpuHpEl = document.getElementById('cpu-hp');
		const cpuChargeEl = document.getElementById('cpu-charge');
		const cpuActionDisplay = document.getElementById('cpu-action-display');
		const cpuPanel = document.getElementById('cpu-panel');
		const actionButtons = document.querySelectorAll('.action-button');
		const beatIndicators = [
			document.getElementById('beat-1'),
			document.getElementById('beat-2'),
			document.getElementById('beat-3'),
			document.getElementById('beat-4'),
		];

		// --- ゲームの状態管理 ---
		let playerState = { hp: 3, charge: 0 };
		let cpuState = { hp: 3, charge: 0 };
		let playerAction = 'CHARGE'; // 3拍目までに入力がない場合のデフォルト
		let cpuAction = '';
		let lastPlayerAction = '';
		let lastCpuAction = '';
		let currentBeat = 0;
		let isGameRunning = false;
		let audioInitialized = false;

		// --- サウンド設定 (Tone.js) ---
		const synth = new Tone.Synth().toDestination();
		const noiseSynth = new Tone.NoiseSynth({
			noise: { type: 'white' },
			envelope: { attack: 0.005, decay: 0.1, sustain: 0 }
		}).toDestination();


		// --- ゲームの初期化 ---
		function initGame() {
			playerState = { hp: 3, charge: 0 };
			cpuState = { hp: 3, charge: 0 };
			playerAction = 'CHARGE';
			cpuAction = '';
			lastPlayerAction = '';
			lastCpuAction = '';
			currentBeat = 0;
			updateUI();
			updateGuardAvailability();
			messageText.textContent = 'Get Ready...';
			gameScreen.classList.remove('hidden');
			startScreen.classList.add('hidden');
			gameOverScreen.classList.add('hidden');
		}

		// --- UI更新 ---
		function updateUI() {
			playerHpEl.textContent = playerState.hp;
			playerChargeEl.textContent = playerState.charge;
			cpuHpEl.textContent = cpuState.hp;
			cpuChargeEl.textContent = cpuState.charge;

			// ATTACKボタンの有効/無効化
			const attackButton = document.getElementById('attack-button');
			attackButton.disabled = playerState.charge === 0;
		}

		// --- ガードボタンの有効/無効を切り替え ---
		function updateGuardAvailability() {
			const guardButton = document.getElementById('guard-button');
			if (lastPlayerAction === 'GUARD') {
				guardButton.disabled = true;
			} else {
				guardButton.disabled = false;
			}
		}

		// --- ゲームループ ---
		const gameLoop = (time) => {
			currentBeat = (currentBeat % 4) + 1;

			// UIスレッドでの更新をスケジュール
			Tone.Draw.schedule(() => {
				updateBeatIndicator();

				// 拍ごとの処理
				switch (currentBeat) {
					case 1:
						messageText.textContent = 'パン！';
						hideActions();
						updateGuardAvailability();
						break;
					case 2:
						messageText.textContent = 'パン！';
						break;
					case 3:
						messageText.textContent = 'ACTION!';
						executeActions(time);
						showActions();
						break;
					case 4:
						messageText.textContent = '...';
						resolveTurn(time);
						checkGameOver();
						break;
				}
			}, time);

			// サウンドの再生
			if (currentBeat <= 2) {
				synth.triggerAttackRelease('C5', '8n', time);
			}
		};

		// --- 拍子インジケーターの更新 ---
		function updateBeatIndicator() {
			beatIndicators.forEach((el, index) => {
				if (index + 1 === currentBeat) {
					el.classList.add('active');
				} else {
					el.classList.remove('active');
				}
			});
		}

		// --- 3拍目: アクションの実行 ---
		function executeActions(time) {
			// CPUのアクション決定
			cpuAction = getCpuAction();

			// サウンド再生
			playActionSound(playerAction, time);
			playActionSound(cpuAction, time + 0.05); // 少しだけ時間をずらす

			// UIにアクションを表示
			playerActionDisplay.textContent = playerAction;
			cpuActionDisplay.textContent = cpuAction;

			// アクションの文字色を設定
			setActionColor(playerActionDisplay, playerAction);
			setActionColor(cpuActionDisplay, cpuAction);

			// パネルのスタイルを設定
			setPanelStyle(playerPanel, playerAction);
			setPanelStyle(cpuPanel, cpuAction);
		}

		// アクションの表示・非表示
		function showActions() {
			playerActionDisplay.classList.add('action-enter');
			cpuActionDisplay.classList.add('action-enter');
		}
		function hideActions() {
			playerActionDisplay.classList.remove('action-enter');
			cpuActionDisplay.classList.remove('action-enter');

			// アクションの文字色をリセット
			playerActionDisplay.classList.remove('text-yellow-400', 'text-red-500', 'text-blue-400');
			cpuActionDisplay.classList.remove('text-yellow-400', 'text-red-500', 'text-blue-400');

			// パネルのスタイルをリセット
			const panels = [playerPanel, cpuPanel];
			panels.forEach(panel => {
				panel.classList.remove('border-yellow-400', 'border-red-500', 'border-blue-400', 'bg-yellow-500/50', 'bg-red-500/50', 'bg-blue-500/50');
				panel.classList.add('border-gray-300', 'bg-gray-800/50');
			});
		}

		// --- アクション表示の文字色を設定 ---
		function setActionColor(element, action) {
			// Remove existing colors first
			element.classList.remove('text-yellow-400', 'text-red-500', 'text-blue-400');
			switch (action) {
				case 'CHARGE':
					element.classList.add('text-yellow-400');
					break;
				case 'ATTACK':
					element.classList.add('text-red-500');
					break;
				case 'GUARD':
					element.classList.add('text-blue-400');
					break;
			}
		}

		// --- パネルのスタイル（枠と背景色）を設定 ---
		function setPanelStyle(panel, action) {
			// Remove default and other action colors first
			panel.classList.remove('border-gray-300', 'bg-gray-800/50', 'border-yellow-400', 'bg-yellow-500/50', 'border-red-500', 'bg-red-500/50', 'border-blue-400', 'bg-blue-500/50');

			switch (action) {
				case 'CHARGE':
					panel.classList.add('border-yellow-400', 'bg-yellow-500/50');
					break;
				case 'ATTACK':
					panel.classList.add('border-red-500', 'bg-red-500/50');
					break;
				case 'GUARD':
					panel.classList.add('border-blue-400', 'bg-blue-500/50');
					break;
			}
		}

		// --- CPUのAIロジック ---
		function getCpuAction() {
			let actions = ['CHARGE', 'GUARD'];

			// 連続ガードを防止
			if (lastCpuAction === 'GUARD') {
				const guardIndex = actions.indexOf('GUARD');
				if (guardIndex > -1) {
					actions.splice(guardIndex, 1);
				}
			}

			if (cpuState.charge > 0) {
				actions.push('ATTACK');
			}

			// 基本はランダム
			let choice = actions[Math.floor(Math.random() * actions.length)];

			// 少しだけ賢くする
			if (actions.includes('ATTACK')) {
				if (playerState.charge >= 2 && cpuState.charge > 0) {
					if (Math.random() < 0.5) choice = 'ATTACK';
				}
				if (cpuState.charge > playerState.charge && cpuState.charge > 0) {
					if (Math.random() < 0.5) choice = 'ATTACK';
				}
			}
			if (actions.includes('GUARD')) {
				if (cpuState.hp <= 1) {
					if (Math.random() < 0.5) choice = 'GUARD';
				}
			}

			return choice || 'CHARGE'; // actionsが空になることはないはずだが念のため
		}

		// --- 4拍目: 結果判定 ---
		function resolveTurn(time) {
			let turnMessage = '';
			const pa = playerAction;
			const ca = cpuAction;

			const playerCanAttack = pa === 'ATTACK' && playerState.charge > 0;
			const cpuCanAttack = ca === 'ATTACK' && cpuState.charge > 0;

			// ATTACK vs ATTACK: 相殺 (Cancel out)
			if (playerCanAttack && cpuCanAttack) {
				playerState.charge--;
				cpuState.charge--;
				turnMessage = 'ATTACKS CANCELED!';
			} else {
				// --- 他のすべてのケース ---
				// CHARGE
				if (pa === 'CHARGE') {
					if (playerState.charge < 3) {
						playerState.charge++;
						turnMessage += 'PLAYER CHARGED! ';
					}
				}
				if (ca === 'CHARGE') {
					if (cpuState.charge < 3) {
						cpuState.charge++;
						turnMessage += 'CPU CHARGED!';
					}
				}

				// ATTACK
				let playerAttackSuccess = false;
				let cpuAttackSuccess = false;

				if (pa === 'ATTACK') {
					if (playerState.charge > 0) {
						playerState.charge--;
						if (ca !== 'GUARD') {
							playerAttackSuccess = true;
						} else {
							turnMessage = 'PLAYER ATTACK GUARDED! ';
						}
					}
				}
				if (ca === 'ATTACK') {
					if (cpuState.charge > 0) {
						cpuState.charge--;
						if (pa !== 'GUARD') {
							cpuAttackSuccess = true;
						} else {
							turnMessage += 'CPU ATTACK GUARDED!';
						}
					}
				}

				// ダメージ計算
				let hits = 0;
				if (playerAttackSuccess) {
					cpuState.hp--;
					turnMessage = 'PLAYER HITS! ';
					noiseSynth.triggerAttackRelease('0.2n', time + (hits * 0.1));
					hits++;
					cpuHpEl.classList.add('status-update');
				}
				if (cpuAttackSuccess) {
					playerState.hp--;
					turnMessage += 'CPU HITS!';
					noiseSynth.triggerAttackRelease('0.2n', time + (hits * 0.1));
					hits++;
					playerHpEl.classList.add('status-update');
				}
			}

			if (turnMessage.trim()) {
				messageText.textContent = turnMessage.trim();
			} else {
				messageText.textContent = '...DRAW...';
			}

			lastPlayerAction = pa;
			lastCpuAction = ca;

			// アニメーションクラスを削除
			setTimeout(() => {
				playerHpEl.classList.remove('status-update');
				cpuHpEl.classList.remove('status-update');
			}, 500);

			updateUI();
			playerAction = 'CHARGE'; // 次のターンのデフォルトを設定
		}

		// --- ゲームオーバー判定 ---
		function checkGameOver() {
			if (playerState.hp <= 0 || cpuState.hp <= 0) {
				isGameRunning = false;
				Tone.Transport.stop();
				Tone.Transport.cancel();

				const gameOverMessage = document.getElementById('game-over-message');
				if (playerState.hp <= 0 && cpuState.hp <= 0) {
					gameOverMessage.textContent = 'DRAW';
				} else if (playerState.hp <= 0) {
					gameOverMessage.textContent = 'YOU LOSE...';
				} else {
					gameOverMessage.textContent = 'YOU WIN!';
				}

				gameScreen.classList.add('hidden');
				gameOverScreen.classList.remove('hidden');
			}
		}

		// --- アクション音の再生 ---
		function playActionSound(action, time) {
			switch (action) {
				case 'CHARGE':
					synth.triggerAttackRelease('E5', '8n', time);
					break;
				case 'GUARD':
					synth.triggerAttackRelease('G4', '8n', time);
					break;
				case 'ATTACK':
					if ((action === playerAction && playerState.charge > 0) || (action === cpuAction && cpuState.charge > 0)) {
						synth.triggerAttackRelease('G5', '8n', time);
					}
					break;
			}
		}

		// --- イベントリスナー ---
		// ゲーム開始ボタン
		startButton.addEventListener('click', () => {
			if (!audioInitialized) {
				Tone.start();
				audioInitialized = true;
				console.log('Audio context started');
			}
			initGame();
			isGameRunning = true;
			Tone.Transport.bpm.value = 240;
			Tone.Transport.scheduleRepeat(gameLoop, '4n');
			Tone.Transport.start();
		});

		// リスタートボタン
		restartButton.addEventListener('click', () => {
			initGame();
			isGameRunning = true;
			// ゲームループを再度スケジュールする
			Tone.Transport.scheduleRepeat(gameLoop, '4n');
			Tone.Transport.start();
		});

		// アクションボタン
		actionButtons.forEach(button => {
			button.addEventListener('click', () => {
				if (!isGameRunning || currentBeat === 4 || button.disabled) return;
				playerAction = button.dataset.action;

				// プレイヤーにフィードバック
				button.classList.add('ring-4', 'ring-white');
				setTimeout(() => button.classList.remove('ring-4', 'ring-white'), 200);
			});
		});

		// --- キーボード入力 ---
		document.addEventListener('keydown', (event) => {
			if (!isGameRunning || currentBeat === 4) return;

			let selectedAction = '';
			let buttonToHighlight = null;

			switch (event.code) {
				case 'ShiftLeft':
				case 'ShiftRight':
					selectedAction = 'CHARGE';
					buttonToHighlight = document.getElementById('charge-button');
					break;
				case 'Space':
					event.preventDefault(); // スペースキーでのスクロールを防止
					buttonToHighlight = document.getElementById('guard-button');
					if (buttonToHighlight.disabled) return;
					selectedAction = 'GUARD';
					break;
				case 'Enter':
					event.preventDefault(); // Enterキーでのボタン再クリックを防止
					selectedAction = 'ATTACK';
					buttonToHighlight = document.getElementById('attack-button');
					break;
			}

			if (selectedAction) {
				if (selectedAction === 'ATTACK' && playerState.charge === 0) return;
				playerAction = selectedAction;
				// プレイヤーにフィードバック
				if (buttonToHighlight) {
					buttonToHighlight.classList.add('ring-4', 'ring-white');
					setTimeout(() => buttonToHighlight.classList.remove('ring-4', 'ring-white'), 200);
				}
			}
		});

		// 音声再生の許可（画面クリック）
		document.body.addEventListener('click', () => {
			if (!audioInitialized) {
				Tone.start();
				audioInitialized = true;
				console.log('Audio context started by body click');
			}
		}, { once: true });
	</script>
</body>

</html>