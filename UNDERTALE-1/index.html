<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Undertale風戦闘システム</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
	<style>
		:root {
			--border-style: 4px solid #fff;
			--box-bg-color: #000;
			--font-family: 'Press Start', cursive;
			--font-color: #fff;
		}

		/* Additional sizing variables for clarity and single source of truth */
		:root {
			--game-width: 640px;
			--game-height: 480px;
			--battle-size: 150px;
			/* canvas size & message-window height */
			--battle-inner-size: 150px;
			/* playable square inside the canvas */
			--attack-mode-width: calc(var(--battle-size) * 0.9);
			--attack-bar-height: 20px;
			--player-size: 20px;
			--hp-bar-width: 120px;
			--hp-bar-height: 20px;
			--enemy-hp-width: 300px;
			--enemy-hp-height: 18px;
			--attack-button-width: 120px;
			--attack-button-height: 50px;
			--enemy-mark-top: 8px;
			--enemy-mark-size: 40px;
			--enemy-info-offset: 28px;
			/* desktop */
			--enemy-info-offset-mobile: 16px;
			/* mobile */
			--message-bottom: 100px;
			--message-height: var(--battle-inner-size);
			/* cached half game height for placement calculations */
			--game-half: calc(var(--game-height) / 2);
			/* message window equals playable square height */
		}

		body {
			background-color: #000;
			color: var(--font-color);
			font-family: var(--font-family);
			height: 100vh;
			margin: 0;
			overflow: hidden;
			/* スクロールバーを非表示 */
		}

		#game-container {
			width: var(--game-width);
			height: var(--game-height);
			background-color: var(--box-bg-color);
			border: var(--border-style);
			display: flex;
			/* gridからflexに変更 */
			flex-direction: column;
			justify-content: center;
			/* 上下中央寄せ */
			align-items: center;
			/* 左右中央寄せ */
			padding: 20px;
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
		}

		@media (max-width: 640px) {
			#game-container {
				width: 100vw;
				height: 60vh;
				/* 高さを調整 */
				border: none;
				padding: 5px;
				transform: scale(1);
			}

			/* モバイル時は敵名/HPを少し控えめに下げる */
			#enemy-info {
				margin-top: var(--enemy-info-offset-mobile);
			}
		}


		#top-section {
			/* 敵やメッセージが表示されるエリア (今は空) */
			flex-grow: 1;
			/* 中央寄せのためにスペースを確保 */
		}

		/* 敵のHP表示 */
		#enemy-info {
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 6px;
			position: relative;
			z-index: 60;
			margin-top: var(--enemy-info-offset);
			/* lower enemy name & HP bar a bit */
		}

		#enemy-name {
			font-size: 16px;
			color: #fff;
		}

		#enemy-hp-container {
			width: var(--enemy-hp-width);
			height: var(--enemy-hp-height);
			border: 2px solid #fff;
			background: #222;
		}

		#enemy-hp-bar {
			width: 100%;
			height: 100%;
			background: #f33;
			transition: width 0.25s ease-out;
		}

		#enemy-hp-value {
			font-size: 12px;
			color: #fff;
		}

		/* 敵のマーク（💀）を常に上部に表示する */
		#enemy-mark {
			position: absolute;
			/* 親の #game-container が relative なのでそこに対して配置 */
			top: var(--enemy-mark-top);
			left: 50%;
			transform: translateX(-50%);
			font-size: var(--enemy-mark-size);
			line-height: 1;
			z-index: 10;
			pointer-events: none;
			/* クリックを邪魔しない */
			user-select: none;
			-webkit-user-select: none;
			color: #fff;
			text-shadow: 0 0 6px rgba(0, 0, 0, 0.8);
		}

		/* プレイヤー情報を常にゲームコンテナの下に表示する（画面左上に流れないよう固定） */
		#player-info {
			position: absolute;
			left: 50%;
			transform: translateX(-50%);
			top: calc(50% + var(--game-half) + 36px);
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 20px;
			font-size: 18px;
			width: var(--game-width);
			text-align: center;
			z-index: 10;
		}

		#hp-bar-container {
			width: var(--hp-bar-width);
			height: var(--hp-bar-height);
			border: 2px solid #fff;
		}

		#hp-bar {
			width: 100%;
			height: 100%;
			background-color: #ff0;
			/* 黄色 */
			transition: width 0.2s ease-out;
		}


		#battle-box-container {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 10;
		}

		#message-window.mode-battle #battle-box-container,
		#message-window.mode-attack #battle-box-container {
			display: flex;
		}

		#battle-canvas {
			background-color: #000;
			width: var(--battle-size);
			height: var(--battle-size);
		}

		#options-container {
			position: absolute;
			left: 50%;
			transform: translateX(-50%);
			top: calc(50% + var(--game-half) + 92px);
			display: flex;
			flex-direction: row;
			justify-content: center;
			gap: 24px;
			width: var(--game-width);
			align-items: center;
			z-index: 10;
		}

		@media (max-width: 640px) {

			#player-info,
			#options-container {
				width: 100vw;
				left: 50%;
				transform: translateX(-50%);
			}

			#player-info {
				font-size: 14px;
				gap: 10px;
				padding: 0 10px;
			}

			#options-container {
				gap: 10px;
				padding: 0 10px;
				/* on mobile, stack vertically */
				display: grid;
				grid-template-columns: 2fr;
			}

			.option-button {
				font-size: 16px !important;
			}
		}


		.option-button {
			background: none;
			border: none;
			color: var(--font-color);
			font-family: var(--font-family);
			font-size: 22px;
			text-align: left;
			cursor: pointer;
			display: flex;
			align-items: center;
		}

		.option-button:hover,
		.option-button.selected {
			color: #ff0;
			/* 黄色 */
		}

		/* 選択中のオプションにハートマークを表示 */
		/* ハート用の固定スペースを確保（非選択時は透明） */
		.option-button::before {
			content: '';
			display: inline-block;
			width: 28px; /* 固定幅で文字が動かないようにする */
			margin-right: 10px;
			font-size: 20px;
			line-height: 1;
			text-align: center;
		}

		.option-button.selected::before {
			content: '❤️';
			/* display は継続して inline-block */
		}

		.hide-heart .option-button.selected::before {
			/* keep placeholder space but hide the heart glyph so layout doesn't shift */
			content: '';
			display: inline-block;
			visibility: hidden;
			width: 28px; /* match default placeholder width */
			margin-right: 10px;
		}

		.heart-icon {
			width: 24px;
			height: 24px;
			margin-right: 15px;
		}

		#joystick-container {
			position: fixed;
			bottom: 30px;
			right: 30px;
			width: 150px;
			height: 150px;
			opacity: 0.8;
			display: block;
		}

		#game-over {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			font-size: 48px;
			color: red;
			display: none;
			text-align: center;
		}

		#game-clear {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			font-size: 48px;
			color: #00ff66;
			display: none;
			text-align: center;
		}

		#attack-button {
			position: absolute;
			bottom: 40px;
			left: 50%;
			transform: translateX(-50%);
			width: var(--attack-button-width);
			height: var(--attack-button-height);
			background-color: #ff0;
			color: #000;
			border: 2px solid #fff;
			font-family: var(--font-family);
			font-size: 18px;
			display: none;
			/* Initially hidden */
			justify-content: center;
			align-items: center;
			cursor: pointer;
			z-index: 20;
			border-radius: 5px;
		}

		/* When battle needs to be shown above messages (e.g. PLAYER_ATTACK), bring these forward */
		.bring-front {
			z-index: 120 !important;
			position: relative !important;
		}

		/* メッセージウィンドウ（バトルフレーム） */
		#message-window {
			position: absolute;
			left: 50%;
			top: auto;
			bottom: var(--message-bottom);
			transform: translate(-50%, 0);
			width: calc(100% - 40px);
			height: var(--battle-size);
			background: rgba(0, 0, 0, 0.9);
			border: var(--border-style);
			padding: 12px;
			text-align: center;
			z-index: 40;
			font-size: 14px;
			color: var(--font-color);
			box-sizing: border-box;
			overflow: hidden;
			display: flex;
			align-items: center;
			justify-content: center;
			pointer-events: auto;
			font-family: var(--font-family);
			transition: width 0.35s ease, height 0.35s ease, top 0.35s ease, bottom 0.35s ease,
				transform 0.35s ease, padding 0.35s ease, background 0.35s ease, opacity 0.25s ease;
		}

		#message-window.no-transition {
			transition: none !important;
		}

		#message-window.hidden {
			opacity: 0;
			pointer-events: none;
		}

		#message-window.mode-message {
			bottom: var(--message-bottom);
			top: auto;
			transform: translate(-50%, 0);
			width: calc(100% - 40px);
			height: var(--battle-size);
			padding: 12px;
			background: rgba(0, 0, 0, 0.9);
			pointer-events: auto;
		}

		#message-window.mode-attack {
			bottom: var(--message-bottom);
			top: auto;
			transform: translate(-50%, 0);
			width: var(--attack-mode-width);
			height: var(--battle-size);
			padding: 12px;
			background: rgba(0, 0, 0, 0.9);
			pointer-events: none;
		}

		#message-window.mode-battle {
			bottom: var(--message-bottom);
			top: auto;
			transform: translate(-50%, 0);
			width: var(--battle-size);
			height: var(--battle-size);
			padding: 0;
			border: var(--border-style);
			background: rgba(0, 0, 0, 0.92);
			pointer-events: none;
		}

		#message-content {
			width: 100%;
			display: flex;
			flex-wrap: wrap;
			justify-content: center;
			gap: 12px;
			align-items: center;
			text-align: center;
			transition: opacity 0.2s ease;
		}

		#message-window.mode-attack #message-content,
		#message-window.mode-battle #message-content {
			opacity: 0;
			pointer-events: none;
		}

		/* 攻撃対象選択ボタンのスタイル */
		.target-select-btn {
			background: #222;
			color: #fff;
			border: 2px solid #fff;
			font-family: var(--font-family);
			font-size: 18px;
			margin: 0 8px;
			padding: 8px 16px;
			border-radius: 6px;
			cursor: pointer;
		}
		.target-select-btn.selected {
			background: #ff0;
			color: #000;
			border-color: #ff0;
		}

		/* 選択中ターゲットの左にハートを表示 */
		.target-select-btn.selected::before {
			content: '❤️';
			display: inline-block;
			margin-right: 8px;
			font-size: 18px;
			line-height: 1;
		}
		.target-select-btn:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}
	</style>
</head>

<body>

	<div id="game-container">
		<div id="top-section">
			<!-- 敵情報 -->
			<div id="enemy-info">
				<div id="enemy-name">SKELETON</div>
				<div id="enemy-hp-container">
					<div id="enemy-hp-bar"></div>
				</div>
				<div id="enemy-hp-value">30 / 30</div>
			</div>
			<!-- メッセージウィンドウ（行動選択時にメッセージを表示） -->
			<div id="message-window" class="mode-message hidden" role="status" aria-live="polite">
				<div id="message-content"></div>
				<div id="battle-box-container">
					<canvas id="battle-canvas" width="250" height="250"></canvas>
				</div>
			</div>
		</div>
		<div id="enemy-mark">💀</div>
		<div id="attack-button">ATTACK</div>
		<div id="game-over">GAME OVER</div>
		<div id="game-clear">GAME CLEAR</div>
	</div>

	<div id="player-info">
		<span>PLAYER</span>
		<span>LV 1</span>
		<div id="hp-bar-container">
			<div id="hp-bar"></div>
		</div>
		<span id="hp-value">20 / 20</span>
	</div>

	<div id="options-container">
		<button class="option-button selected" id="fight">
			* FIGHT
		</button>
		<button class="option-button" id="act">
			* ACT
		</button>
		<button class="option-button" id="item">
			* ITEM
		</button>
		<button class="option-button" id="mercy">
			* MERCY
		</button>
	</div>
	<div id="target-select-container" style="display:none; justify-content:center; gap:16px; margin:12px 0;"></div>

	<div id="joystick-container"></div>

	<script type="module" src="./main.ts"></script>
</body>

</html>
